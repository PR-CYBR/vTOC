# vTOC Platform

vTOC is a virtual tactical operations center that pairs a FastAPI backend, a map-first Vite frontend, and automation agents with
an orchestration layer powered by **ChatKit** and **AgentKit**. The platform now supports station-scoped workflows where
Operations, Intelligence, and Logistics teams can collaborate through shared ChatKit channels while their on-premise stations run
role-aware AgentKit playbooks. The repository ships with a unified setup interface, container images for local or swarm-based
deployment, and automation for Fly.io delivery from the hardened `live` branch.

![CI](https://github.com/PR-CYBR/vTOC/actions/workflows/ci.yml/badge.svg) ![Preview Deploy](https://github.com/PR-CYBR/vTOC/actions/workflows/preview-deploy.yml/badge.svg)

## Quick start

```bash
# 1. Generate station configuration and env files
python -m scripts.bootstrap_cli setup local

# 2. Start the backend/frontend dev servers
pnpm --dir frontend dev
uvicorn backend.app.main:app --host 0.0.0.0 --port 8080
```

All Makefile targets now forward to this CLI so existing `make setup-local`
workflows continue to function. Windows users without GNU Make can invoke the
Python entry point directly via `python -m scripts.bootstrap_cli ...`.

During development the backend exposes `http://localhost:8080/healthz` and the frontend renders on
`http://localhost:5173` (or `8081` when using the containerized stack). ChatKit sandboxes, AgentKit playbooks, and station
metadata are stored in `.env.local` / `.env.station` files that are generated by the setup script.

### Environment variables

| Variable | Scope | Description |
| --- | --- | --- |
| `DATABASE_URL` | Backend | SQLAlchemy connection string for the station database. Populated by setup for each station role. |
| `POSTGRES_STATION_ROLE` | All services | Role identifier (`ops`, `intel`, `logistics`) used to bind ChatKit channels to the correct AgentKit playbooks. |
| `POSTGRES_POOL_SIZE` | Backend | Optional override for multi-station connection pooling. |
| `CHATKIT_API_KEY` | Backend, Agents | API token for ChatKit orchestration. |
| `CHATKIT_ORG_ID` | Backend, Agents | Organization identifier required to join shared channels. |
| `AGENTKIT_CLIENT_ID` / `AGENTKIT_CLIENT_SECRET` | Agents | OAuth credentials for AgentKit workflow execution. |
| `STATION_CALLSIGN` | Frontend, Agents | Friendly identifier rendered in the UI header and propagated to telemetry events. |
| `TELEMETRY_BROADCAST_URL` | Agents | Optional WebSocket endpoint for streaming telemetry into ChatKit threads. |

See [`docs/QUICKSTART.md`](docs/QUICKSTART.md) for role-specific bootstrap instructions and
[`docs/DEPLOYMENT.md`](docs/DEPLOYMENT.md) for production notes.

## ChatKit / AgentKit workflow

Each station is bootstrapped with a ChatKit channel named after the `STATION_CALLSIGN`. The backend exposes `/api/v1/chatkit`
webhooks that translate channel events into AgentKit runs. AgentKit playbooks dispatch telemetry connectors and update the
mission log while respecting station roles:

1. ChatKit receives operator prompts or telemetry alerts.
2. The backend normalizes the message and schedules an AgentKit run matching the `POSTGRES_STATION_ROLE`.
3. AgentKit invokes domain-specific tasks (for example, Logistics triggers supply chain lookups, Intelligence scores sensor
   packets, and Operations coordinates mission overlays).
4. Results are written back to ChatKit and persisted through the telemetry subsystem.

An end-to-end overview is available in [`docs/ARCHITECTURE.md`](docs/ARCHITECTURE.md) together with updated diagrams in
[`docs/DIAGRAMS.md`](docs/DIAGRAMS.md).

## Deployment modes

| Mode | Command | Description |
| --- | --- | --- |
| Local dev | `python -m scripts.bootstrap_cli setup local` (or `make setup-local`) | Installs dependencies, writes `.env.local`, and provisions ChatKit/AgentKit sandbox credentials. |
| Generated Compose | `python -m scripts.bootstrap_cli setup container --apply` (or `make setup-container`) | Produces `docker-compose.generated.yml`, interpolates station secrets, and starts the stack with role-specific services. |
| Infrastructure | `python -m scripts.bootstrap_cli setup cloud` (or `make setup-cloud`) | Generates Terraform/Ansible scaffolding in `infra/` with multi-station Postgres plans. |
| Cleanup | `python -m scripts.bootstrap_cli compose down` (or `make compose-down`) | Tears down services started from the generated compose file and removes role-specific temp volumes. |

Supply configuration through `--config path.json` or `--config-json '{...}'`. The schema now includes `stationRoles[]` and
`chatkit`/`agentkit` sections – see [`scripts/inputs.schema.json`](scripts/inputs.schema.json) for details.

Codex CLI is detected automatically: if the `codex` binary exists, the setup scripts use `codex interpolate` for variable
expansion; otherwise they fall back to portable Bash implementations.

## Containers and orchestration

* `docker-compose.yml` — developer stack (Postgres, FastAPI backend, Vite frontend via nginx, telemetry scraper)
* `docker-stack.yml` — Docker Swarm with Traefik routing (`vtoc.local` / `api.vtoc.local`) and optional integrations
  (ZeroTier, Tailscale, MediaMTX, TAK Server)
* `fly.toml` — Fly.io deployment descriptor for the backend container deployed from the `live` branch

Images are built and pushed to GHCR via GitHub Actions as part of [`ci.yml`](.github/workflows/ci.yml):

- `ghcr.io/<repo>/frontend` (Vite static bundle served by nginx)
- `ghcr.io/<repo>/backend` (FastAPI + Uvicorn on port 8080)
- `ghcr.io/<repo>/scraper` (RSS/HTML telemetry agent)

A Fly.io dispatch workflow (`fly-deploy.yml`) deploys the backend using the prebuilt image when `live` receives new commits or
when tags matching `v*` are pushed. Operators promoting builds manually can use [`scripts/fly_deploy.sh`](scripts/fly_deploy.sh)
to export the required GitHub Container Registry credentials and run `flyctl deploy --remote-only` with the pinned backend
image.

## Frontend

The Vite/React frontend consumes the backend via `frontend/src/services/api.ts`, renders station overlays, and includes a
ChatKit mission console sidebar. Environment configuration lives in [`frontend/.env.example`](frontend/.env.example) and is
propagated through the setup scripts. Station role badges and callsigns are hydrated from the generated `.env.station` file.

Key scripts:

```bash
pnpm --dir frontend dev       # local dev server on 5173
pnpm --dir frontend build     # generate production bundle
pnpm --dir frontend test      # run vitest suite in CI mode
```

## Backend

The FastAPI backend (`backend/app`) provides:

* `/healthz` — health probe
* `/api/v1/telemetry/*` — CRUD for telemetry sources and events
* `/api/v1/chatkit/webhook` — Receives ChatKit events and launches AgentKit runs scoped to the station role
* `/api/v1/stations` — Registers and reports station metadata

Database connectivity is supplied through `DATABASE_URL`. SQLAlchemy models and Alembic migrations live under `backend/app` and
`alembic/`. Run migrations with:

```bash
alembic upgrade head
```

## Telemetry scraper and AgentKit bridge

`agents/scraper` reads feeds from `config.yaml` and posts normalized telemetry to the backend. AgentKit playbooks can invoke the
same connectors via the shared configuration module, enabling ChatKit-driven automations. Run locally with
`python -m scripts.bootstrap_cli scraper run` (or `make scraper-run`) or containerize via the provided Dockerfile.

## Documentation map

* [`docs/QUICKSTART.md`](docs/QUICKSTART.md) — station bootstrap, env variables, and local workflows.
* [`docs/ARCHITECTURE.md`](docs/ARCHITECTURE.md) — component inventory, ChatKit/AgentKit flows, and station roles.
* [`docs/DEPLOYMENT.md`](docs/DEPLOYMENT.md) — multi-station Postgres provisioning, Docker, Swarm, and Fly.io.
* [`docs/TELEMETRY_CONNECTORS.md`](docs/TELEMETRY_CONNECTORS.md) — connector catalog with AgentKit integration notes.
* [`docs/DIAGRAMS.md`](docs/DIAGRAMS.md) — updated system diagrams referencing ChatKit and station boundaries.
* [`docs/CHANGELOG.md`](docs/CHANGELOG.md) — migration notes for existing operators.

Additional deployment guidance is available in [`docs/DEPLOYMENT.md`](docs/DEPLOYMENT.md) including Compose, Swarm, Fly.io, and sample `inputs.json` files for each setup mode. For production status updates and release notes, subscribe to the GitHub Discussion **Deployment Strategy: live branch** (link in the deployment guide) so you know when `live` has been updated and whether a rollback or hotfix is in flight.
