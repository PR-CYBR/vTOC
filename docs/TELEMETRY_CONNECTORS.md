# Telemetry Connector Guide

This guide explains how to configure the telemetry ingestion pipeline that powers the vTOC data lake.  Each connector can operate against live services or replay historical captures from files and devices.  Configuration is managed from `agents/config/agents.yml` and persisted in the backend database through the new telemetry models.

## Backend data model

The backend now exposes `TelemetrySource` and `TelemetryEvent` tables via Alembic migrations.  Use the FastAPI endpoints under `/api/telemetry` to register sources, ingest readings, and query stored data:

| Endpoint | Description |
| --- | --- |
| `POST /api/telemetry/sources` | Create or update telemetry source metadata |
| `POST /api/telemetry/ingest/{source}` | Push live readings from connectors, webhooks, or scripts |
| `GET /api/telemetry/events` | Retrieve stored telemetry with filtering by source and time |

## Agent configuration template

```yaml
sources:
  <slug>:
    type: adsb|ais|aprs|tle|rtlsdr|meshtastic|gps
    enabled: true
    schedule: "*/5 * * * *"  # cron-style shorthand or minute interval
    mode: online|offline
    backend_url: "http://backend:8000"  # API root used by the agent to push events
    # Source specific options...
```

The `schedule` field accepts shorthand values:

* `*/5 * * * *` → every 5 minutes
* `30m` → every 30 minutes
* `15s` → every 15 seconds
* `10` → every 10 minutes

During startup the agent service polls each enabled source immediately before continuing on the defined cadence.

## Connector specifics

### ADS-B (`adsb`)

* **Online**: provide `api_url` and optional `params` for your ADS-B provider (e.g. ADS-B Exchange).  Authenticate using headers or query parameters as required by the provider.
* **Offline**: set `log_path` to a JSON/CSV capture produced by tools like `dump1090`.  The file contents are replayed to the ingest API.

### AIS (`ais`)

* **Online**: configure `api_url` and optional `api_token` for maritime providers such as MarineTraffic or AISHub.  Additional HTTP headers can be added through a `headers` map.
* **Offline**: specify an `capture_path` pointing at an `.nmea` log generated by SDR decoders or shipboard systems.

### APRS (`aprs`)

* **Online**: set `igate_url` to an APRS-IS endpoint or web API.  Responses are forwarded verbatim to the backend for parsing.
* **Offline**: provide `packet_log` referencing stored APRS packets (plain text or JSON).

### TLE (`tle`)

* **Online**: define `tle_url` pointing at a Celestrak or Space-Track feed.
* **Offline**: set `tle_file` to a local TLE catalogue for disconnected operations.

### RTL-SDR (`rtlsdr`)

* **Online**: use `stream_url` (e.g. `rtl_tcp://host:port`) when the SDR is shared over the network.  The agent currently records the connection details for monitoring.
* **Offline**: specify `iq_recording` to replay IQ captures stored on disk.

### Meshtastic (`meshtastic`)

* **Online**: set `http_bridge` to the Meshtastic HTTP API endpoint (commonly `http://<node>:4403/api/v1/telemetry`).
* **Offline**: configure `json_log` to replay exported mesh telemetry.

### GPS (`gps`)

* **Online**: configure `ntrip_endpoint` for RTK/NTRIP casters or other live GPS sources.
* **Offline**: provide either `gpx_file` or `nmea_log` to replay recorded tracks.

## Database migrations

Alembic migrations are stored under `backend/app/migrations`.  Run them with:

```bash
cd backend
alembic upgrade head
```

This will create the telemetry tables if they do not already exist.  The backend still performs a safety `create_all` on startup for development environments.

