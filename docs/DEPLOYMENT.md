# Deployment Guide

This guide covers local workflows, containerized deployments, multi-station Postgres provisioning, and Fly.io delivery from the
`live` branch. The ChatKit/AgentKit rollout introduces additional environment variables and setup steps described below.

## Local development

1. Copy environment examples if desired: `cp .env.example .env`.
2. Run `python -m scripts.bootstrap_cli setup local` (or the `make setup-local` alias) to install dependencies, generate `.env.local`/`.env.station`, and provision ChatKit sandbox channels.
3. Launch the dev servers:
   ```bash
   uvicorn backend.app.main:app --host 0.0.0.0 --port 8080
   pnpm --dir frontend dev
   ```
4. Health checks:
   - Backend: `curl http://localhost:8080/healthz`
   - ChatKit webhook echo: `curl -X POST http://localhost:8080/api/v1/chatkit/webhook -d '{"text":"ping"}'`
   - Frontend: http://localhost:5173

## Docker Compose (development + testing)

1. Generate the compose file and role secrets:
   ```bash
   python -m scripts.bootstrap_cli setup container --apply
   ```
2. Start the stack:
   ```bash
   python -m scripts.bootstrap_cli compose up
   ```
3. Services:
   - Backend: http://localhost:8080
   - Frontend (nginx): http://localhost:8081
   - Postgres: `localhost:5432` with databases `vtoc_ops`, `vtoc_intel`, `vtoc_logistics`
   - Traefik dashboard (optional): http://localhost:8080 when enabled in config

To stop and clean up run `python -m scripts.bootstrap_cli compose down` (or the legacy `make compose-down`).

## Docker Swarm (production)

1. Authenticate with your swarm manager.
2. Ensure secrets are available (`CHATKIT_API_KEY`, `CHATKIT_ORG_ID`, `AGENTKIT_CLIENT_ID`, `AGENTKIT_CLIENT_SECRET`).
3. Deploy:
   ```bash
   docker stack deploy -c docker-stack.yml vtoc
   ```
4. Traefik routes:
   - `Host("vtoc.local")` → frontend (port 8081 in container)
   - `Host("api.vtoc.local")` → backend (port 8080)

Optional integrations (ZeroTier/Tailscale/MediaMTX/TAK Server) can be enabled by adjusting `scripts/inputs.schema.json` and
rerunning `python -m scripts.bootstrap_cli setup container --config path.json --apply` (or the equivalent Make target).

## Multi-station Postgres provisioning

When deploying multiple stations against a shared Postgres server:

- Use the Terraform module under `infrastructure/terraform/postgres` (generated by `python -m scripts.bootstrap_cli setup cloud`, or `make setup-cloud`) to create databases per
  role. Example variables:
  ```hcl
  variable "station_roles" {
    default = ["ops", "intel", "logistics"]
  }
  ```
- Each database follows the `vtoc_<role>` naming pattern and receives its own user/password pair.
- Grant usage rights only to the matching role. Example SQL:
  ```sql
  CREATE ROLE vtoc_ops WITH LOGIN PASSWORD '${POSTGRES_OPS_PASSWORD}';
  GRANT CONNECT ON DATABASE vtoc_ops TO vtoc_ops;
  ```
- Update `.env.local` with per-role connection strings:
  ```env
  DATABASE_URL=postgresql+psycopg2://vtoc_ops:${POSTGRES_OPS_PASSWORD}@db.internal:5432/vtoc_ops
  ```
- Run migrations per database:
  ```bash
  for role in ops intel logistics; do
    POSTGRES_STATION_ROLE=$role alembic upgrade head
  done
  ```

More examples are available in [`docs/DIAGRAMS.md`](DIAGRAMS.md#multi-station-topology).

## Fly.io (live branch)

The Fly deployment ships the backend container using the `live` branch as the source of truth.

1. Ensure `fly.toml` has `primary_region`, `app`, and `[env]` entries for ChatKit/AgentKit secrets or references to Fly secrets.
2. Authenticate: `flyctl auth login` (or set `FLY_API_TOKEN`).
3. Generate a **read-only** GitHub Container Registry token:
   - Navigate to <https://github.com/settings/tokens?type=beta>.
   - Create a fine-grained personal access token scoped to the `PR-CYBR/vTOC` repository with **read-only** permissions for
     GitHub Packages.
   - Record the username (usually your GitHub handle) and the token value.
4. Export registry credentials for the remote Fly builder:
   ```bash
   export GHCR_USERNAME=<github-handle>
   export GHCR_TOKEN=<read-only-ghcr-pat>
   AUTH=$(printf '%s:%s' "$GHCR_USERNAME" "$GHCR_TOKEN" | base64 | tr -d '\n')
   cat <<EOF > docker-auth.json
{"auths":{"ghcr.io":{"auth":"$AUTH"}}}
EOF
   export DOCKER_AUTH_CONFIG=$(cat docker-auth.json)
   rm docker-auth.json
   ```
   The inline auth export mirrors `docker login ghcr.io` and ensures the remote-only build step can pull the private image.
   Alternatively, run `docker login ghcr.io` and export `DOCKER_CONFIG` pointing to your Docker config directory before
   invoking `flyctl deploy`.
5. Deploy the current `live` branch with the prebuilt image:
   ```bash
   git checkout live
   flyctl deploy --remote-only
   ```
   Operators can use the helper script `scripts/fly_deploy.sh` to automate the auth JSON handoff when running promotions from
   their workstation.
6. GitHub Actions triggers (`fly-deploy.yml`) automatically deploy when `live` updates or when `v*` tags are pushed.
7. Post-deployment, verify health: `flyctl status`, `flyctl logs`, and `curl https://<app>.fly.dev/healthz`.

## ChatKit configuration steps

1. Create or select a ChatKit organization and generate an API key with webhook permissions.
2. Configure a webhook endpoint pointing at your backend’s `/api/v1/chatkit/webhook` URL. Set the signature secret to match
   `CHATKIT_WEBHOOK_SECRET` (optional if using defaults).
3. Create channels for each station role. The setup script can automate this when `chatkit.autoProvision` is enabled in the
   config JSON.
4. Invite operator accounts and the AgentKit service user to each channel.
5. In AgentKit, register client credentials and map playbooks to the same station roles used in ChatKit. Update
   `agents/config/agentkit.yml` accordingly.

For visibility into what is currently running in production, use the GitHub Discussion **Deployment Strategy: live branch**. Copy the [live branch operations guide](communications/live-branch.md) into the discussion to seed it if it does not exist, and post deployment or rollback updates there so operators can subscribe to changes.

## Sample configuration inputs

Example `inputs.json` enabling Traefik, specifying station roles, and seeding ChatKit automation:

```json
{
  "projectName": "vtoc",
  "stationRoles": ["ops", "intel", "logistics"],
  "chatkit": {
    "autoProvision": true,
    "orgId": "${CHATKIT_ORG_ID}",
    "webhookSecret": "${CHATKIT_WEBHOOK_SECRET}"
  },
  "agentkit": {
    "clientId": "${AGENTKIT_CLIENT_ID}",
    "clientSecret": "${AGENTKIT_CLIENT_SECRET}"
  },
  "services": {
    "traefik": true,
    "postgres": true,
    "n8n": false,
    "wazuh": false
  }
}
```

Pass this file to `python -m scripts.bootstrap_cli setup container --config inputs.json --apply` (or `make setup-container -- --config inputs.json`) or inline with `--config-json`.

## Additional resources

- [`docs/QUICKSTART.md`](QUICKSTART.md) — station bootstrap instructions.
- [`docs/CHANGELOG.md`](CHANGELOG.md) — migration notes for existing operators.
- [`docs/ARCHITECTURE.md`](ARCHITECTURE.md) — architecture overview.
